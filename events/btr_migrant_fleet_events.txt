
namespace = migrant_fleet

# Start event
country_event = {
	id = migrant_fleet.0
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_country_flag = migrant_fleet
	}
	immediate = {
		random_owned_fleet = {
			limit = {
				has_fleet_flag = migrant_fleet_1
			}
			fleet_event = {
				id = migrant_fleet.1
				days = 1800
			}
		}
	}
}

# Initial Movement
fleet_event = {
	id = migrant_fleet.1
	hide_window = yes
	is_triggered_only = yes
	trigger = {
		has_fleet_flag = migrant_fleet_1
	}
	immediate = {
		# Reset any missed flags
		if = {
			limit = {
				any_system = {
					any_system_planet = { has_planet_flag = migrant_fleet1_capital_destination }
				}
			}
			every_planet = {
				limit = { has_planet_flag = migrant_fleet1_capital_destination }
				remove_planet_flag = migrant_fleet1_capital_destination
			}
		}
		else = {
			while = {
				count = 11
				random_playable_country = {
					limit = {
						NOR = {
							has_country_flag = geth_consensus
							has_country_flag = collectors
							has_country_flag = cerberus
							has_country_flag = rachni_hive
							has_country_flag = migrant_fleet_hostile
						}
						capital_scope = {
							NOT = { has_planet_flag = migrant_fleet1_capital_destination } # change to any colony
						}
						#planet = {
						#	NOT = { has_planet_flag = migrant_fleet1_capital_destination }
						#}
					}
					capital_scope = {
						set_planet_flag = migrant_fleet1_capital_destination
						log = "1 migrant_fleet1_capital_destination set"
					}
					#planet = {
					#	set_planet_flag = migrant_fleet1_capital_destination
					#	log = "1 migrant_fleet1_capital_destination set"
					#}
				}
			}
		}
		solar_system = {
			closest_system = {
				limit = {
					any_system_planet = { has_planet_flag = migrant_fleet1_capital_destination }
				}
				random_system_planet = {
					limit = { has_planet_flag = migrant_fleet1_capital_destination }
					save_event_target_as = migrant_fleet1_next_capital_destination
				}
				event_target:migrant_fleet1_fleet = {
					auto_move_to_planet = {
						target = event_target:migrant_fleet1_next_capital_destination
						clear_auto_move_on_arrival = no
						arrival_effect = migrant_fleet_wait
					}
				}
			}
		}
	}
}

# Fleet move again  
fleet_event = {
	id = migrant_fleet.2
	hide_window = yes
	is_triggered_only = yes
	immediate = {
		log = "triggered migrant_fleet_continue_journey"
		solar_system = {
			closest_system = {
				min_steps = 1
				limit = {
					any_system_planet = {
						OR = {
							is_colony = yes
							is_capital = yes
							is_planet_class = pc_gas_giant
						}
						NOT = { has_planet_flag = migrant_fleet_recent_visit }
						owner = {
							NOR = {
								has_country_flag = geth_consensus
								has_country_flag = collectors
								has_country_flag = cerberus
								has_country_flag = rachni_hive
								has_country_flag = migrant_fleet_hostile
							}
						}
					}
				}
				random_system_planet = {
					limit = {
						OR = {
							is_colony = yes
							is_capital = yes
							is_planet_class = pc_gas_giant
						}
						NOT = { has_planet_flag = migrant_fleet_recent_visit }
						owner = {
							NOR = {
								has_country_flag = geth_consensus
								has_country_flag = collectors
								has_country_flag = cerberus
								has_country_flag = rachni_hive
								has_country_flag = migrant_fleet_hostile
							}
						}
					}
					weights = {
						base = 1
						modifier = { add = 500 is_colony = yes }
						modifier = { add = 250 is_capital = yes }
						modifier = { add = 100 is_planet_class = pc_gas_giant }
					}
					save_event_target_as = migrant_fleet1_next_capital_destination
					log = "migrant_fleet set next destination"
				}
			}
		}
		auto_move_to_planet = {
			target = event_target:migrant_fleet1_next_capital_destination
			clear_auto_move_on_arrival = no
			arrival_effect = migrant_fleet_wait
		}
		log = "migrant_fleet engaged auto_move"
		#else = {
		#	random_planet = { save_event_target_as = temporary_migrant_fleet_destination }
		#	auto_move_to_planet = {
		#		target = event_target:temporary_migrant_fleet_destination
		#		clear_auto_move_on_arrival = no
		#		arrival_effect = migrant_fleet_wait
		#	}
		#	log = "migrant_fleet taking a detour, home is dead/not yet reestablished"
		#}
	}
}

# Migrant Fleet - Evade when attacked by non-Default countries
fleet_event = {
	id = migrant_fleet.3
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_fleet_flag = migrant_fleet_1
		from = {
			exists = owner
			owner = { NOT = { is_country_type = default } }
		}
	}

	immediate = {
		# randomize escape jump distance
		random_list = {
			1 = {
				solar_system = {
					closest_system = {
						min_steps = 2
						limit = { NOT = { has_star_flag = hostile_system } }
						root = {
							set_location = prev.star
						}
					}
				}
			}
			1 = {
				solar_system = {
					closest_system = {
						min_steps = 4
						limit = { NOT = { has_star_flag = hostile_system } }
						root = {
							set_location = prev.star
						}
					}
				}
			}
			1 = {
				solar_system = {
					closest_system = {
						min_steps = 6
						limit = { NOT = { has_star_flag = hostile_system } }
						root = {
							set_location = prev.star
						}
					}
				}
			}
		}
		remove_auto_move_target = yes
		fleet_event = {
			id = migrant_fleet.2
			days = 10
		}
	}
}

# Migrant Fleet - Evade Normal
fleet_event = {
	id = migrant_fleet.17
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_fleet_flag = migrant_fleet_1
	}

	immediate = {
		# randomize escape jump distance
		random_list = {
			1 = {
				solar_system = {
					closest_system = {
						min_steps = 6
						limit = { NOT = { has_star_flag = hostile_system } }
						root = {
							set_location = prev.star
						}
					}
				}
			}
			1 = {
				solar_system = {
					closest_system = {
						min_steps = 10
						limit = { NOT = { has_star_flag = hostile_system } }
						root = {
							set_location = prev.star
						}
					}
				}
			}
			1 = {
				solar_system = {
					closest_system = {
						min_steps = 14
						limit = { NOT = { has_star_flag = hostile_system } }
						root = {
							set_location = prev.star
						}
					}
				}
			}
		}
		remove_auto_move_target = yes
		fleet_event = {
			id = migrant_fleet.2
			days = 10
		}
	}
}

# Migrant Fleet - Destroyed by Default country TODO - add positive opinion from Geth
country_event = {
	id = migrant_fleet.4
	title = migrant_fleet.4.title
	desc = migrant_fleet.4.desc
	picture = btr_GFX_evt_quarian_fleet_destroyed
	location = fromfrom

	is_triggered_only = yes

	trigger = {
		from = {
			is_country_type = migrant_fleet
			has_country_flag = migrant_fleet
		}
		is_country_type = default
	}

	immediate = {
		every_playable_country = {
			limit = {
				has_communications = root.from
				NOT = { is_same_value = root }
			}
			country_event = { id = migrant_fleet.5 } # notification
		}
	}

	option = {
		name = UNDERSTOOD
		add_resource = {
			energy = 2000
			minerals = 2000
		}
		add_opinion_modifier = {
			who = event_target:geth_consensus
			modifier = migrant_fleet_destroyed
		}
	}
}

# Migrant Fleet - Destruction Notification
country_event = {
	id = migrant_fleet.5
	title = migrant_fleet.5.title
	desc = migrant_fleet.5.desc
	picture = btr_GFX_evt_quarian_fleet_destroyed
	location = fromfrom

	is_triggered_only = yes

	option = {
		name = UNFORTUNATE
	}

	option = {
		name = EXCELLENT
		exclusive_trigger = {
			OR = {
			    has_country_flag = geth_consensus
			    has_country_flag = rachni_hive
			    has_country_flag = collectors
			}
		}
	}
}

# Migrant Fleet - Entering Borders
fleet_event = {
	# on_crossing_border
	# Scope = Fleet
	# From = Origin System
	# FromFrom = Destination System
	id = migrant_fleet.6
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = event_target:migrant_fleet1_fleet
		is_same_value = event_target:migrant_fleet1_fleet
		fromfrom = {
			exists = space_owner
			space_owner = {
				is_country_type = default
				NOT = { has_country_flag = recent_migrant_fleet }
			}
		}
		from = {
			OR = {
				NOT = { exists = space_owner }
				AND = {
					exists = space_owner
					space_owner = { NOT = { is_same_value = root.fromfrom.space_owner } }
					# technically redundant
				}
			}
		}
	}

	immediate = {
#		log = "fleet 1 entered system"
		fromfrom.space_owner = {
			set_timed_country_flag = {
				flag = recent_migrant_fleet
				days = 540
			}
		}
		# Establish Communications
		#if = {
		#	limit = { fromfrom.space_owner = { NOT = { has_communications = root.owner } } }
		#	#fromfrom.space_owner = {
		#		#country_event = { id = story.7 }
		#		# moved to separate event to correct scopes
		#		owner = { country_event = { id = cara.1011 } }
		#	#}
		#}
		# First Contact message
		if = {
			limit = { fromfrom.space_owner = { NOT = { has_country_flag = migrant_fleet1_contact } } }
			fromfrom.space_owner = {
				set_country_flag = migrant_fleet1_contact
				country_event = { id = migrant_fleet.7 days = 10 }
			}
		}
		# Return message
		else_if = {
			limit = {
				fromfrom.space_owner = {
					has_country_flag = migrant_fleet1_contact
					NOR = {
						has_country_flag = geth_consensus
			            has_country_flag = rachni_hive
						has_country_flag = collectors
						has_country_flag = migrant_fleet_hostile
					}
				}
			}
			fromfrom.space_owner = {
				country_event = { id = migrant_fleet.8 }
			}
		}
	}
}

# Migrant Fleet - First Contact
country_event = {
	id = migrant_fleet.7
	title = migrant_fleet.7.name
	desc = migrant_fleet.7.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	immediate = {
		if = {
			limit = { NOT = { has_communications = event_target:migrant_fleet } }
			establish_communications_no_message = event_target:migrant_fleet
		}
	}
	option = {
		name = migrant_fleet.7.a # further stuffs 
		ai_chance = {
			factor = 100
		}
		trigger = {
			NOR = {
				has_country_flag = geth_consensus
			    has_country_flag = rachni_hive
			    has_country_flag = collectors
			}
		}
		hidden_effect = {
			country_event = { id = migrant_fleet.8 }
		}
	}
	option = {
		name = migrant_fleet.7.b # demand they leave
		ai_chance = {
			factor = 0
		}
		trigger = {
			NOR = {
				has_country_flag = geth_consensus
			    has_country_flag = rachni_hive
			    has_country_flag = collectors
			}
		}
		hidden_effect = {
			country_event = { id = migrant_fleet.9 }
		}
	}
	option = {
		name = migrant_fleet.7.c # make hostile - country is evil
		exclusive_trigger = {
			OR = {
			    has_country_flag = geth_consensus
			    has_country_flag = rachni_hive
			    has_country_flag = collectors
			}
		}
		hidden_effect = {
			set_country_flag = migrant_fleet_hostile
			event_target:migrant_fleet = {
				set_faction_hostility = {
					set_hostile = yes
				}
			}
			event_target:migrant_fleet1_fleet = {
				fleet_event = {
					id = migrant_fleet.17
					days = 20
				}
			}
		}
	}
	option = {
		name = migrant_fleet.7.d
		default_hide_option = yes
	}
} 

# Migrant Fleet - demand they leave
country_event = {
	id = migrant_fleet.9
	title = migrant_fleet.7.name
	desc = migrant_fleet.9.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	option = {
		name = migrant_fleet.9.a # nevermind
		ai_chance = {
			factor = 100
		}
		hidden_effect = {
			country_event = { id = migrant_fleet.8 }
		}
	}
	option = {
		name = migrant_fleet.9.b # pay
		allow = {
			has_resource = { type = alloys amount >= 400 }
		}
		add_resource = { alloys = -400 }
		hidden_effect = {
			event_target:migrant_fleet1_fleet = {
				fleet_event = {
					id = migrant_fleet.2
					days = 20
				}
			}
			random_owned_planet = {
				limit = {
					has_planet_flag = migrant_fleet_recent_visit
					has_modifier = migrant_fleet_visit
				}
				remove_modifier = migrant_fleet_visit
			}
		}
		response_text = migrant_fleet.9.b.response
	}
	option = {
		name = migrant_fleet.9.c # attack
		hidden_effect = {
			event_target:migrant_fleet = {
				set_faction_hostility = {
					set_hostile = yes
				}
				add_trust = {
					amount = -500
					who = root
				}
			}
			set_country_flag = migrant_fleet_hostile
			event_target:migrant_fleet1_fleet = {
				fleet_event = {
					id = migrant_fleet.17
					days = 20
				}
			}
			random_owned_planet = {
				limit = {
					has_planet_flag = migrant_fleet_recent_visit
					has_modifier = migrant_fleet_visit
				}
				remove_modifier = migrant_fleet_visit
			}
		}
		response_text = migrant_fleet.9.c.response
	}
}

# Migrant Fleet - further stuffs (main menu)
country_event = {
	id = migrant_fleet.8
	title = migrant_fleet.7.name
	desc = migrant_fleet.8.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	option = {
		name = migrant_fleet.8.a # tell us about yourselves
		trigger = {
			NOT = { has_country_flag = migrant_fleet_ask_history }
		}
		hidden_effect = {
			set_country_flag = migrant_fleet_ask_history
			event_target:migrant_fleet = {
				add_trust = {
					amount = 10
					who = root
				}
			}
			country_event = { id = migrant_fleet.10 }
		}
	}
	option = {
		name = migrant_fleet.8.b # ask about leader
		trigger = {
			NOT = { has_country_flag = migrant_fleet_ask_about_leader } 
		}
		hidden_effect = {
			event_target:migrant_fleet = {
				add_trust = {
					amount = 10
					who = root
				}
			}
			set_country_flag = migrant_fleet_ask_about_leader
			country_event = { id = migrant_fleet.11 }
		}
	}
	option = {
		name = migrant_fleet.8.c # we wish to conduct trade
		hidden_effect = {
			country_event = { id = migrant_fleet.12 }
		}
	}
	option = {
		name = migrant_fleet.8.d # hire leader
		trigger = {
			has_country_flag = migrant_fleet_ask_about_leader
		}
		hidden_effect = {
			if = {
				limit = { NOT = { has_country_flag = migrant_fleet_recent_leader_hired } }
				country_event = { id = migrant_fleet.15 }
			}
			if = {
				limit = { has_country_flag = migrant_fleet_recent_leader_hired }
				country_event = { id = migrant_fleet.16 }
			}
		}
	}
	option = {
		name = migrant_fleet.8.e # leave
		ai_chance = {
			factor = 0
		}
		hidden_effect = {
			country_event = { id = migrant_fleet.9 }
		}
	}
	option = {
		name = migrant_fleet.8.f # end communications
		default_hide_option = yes
	}
}

# Migrant Fleet - tell us about yourselves
country_event = {
	id = migrant_fleet.10
	title = migrant_fleet.7.name
	desc = migrant_fleet.10.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	option = {
		name = migrant_fleet.10.a
		hidden_effect = {
			country_event = { id = migrant_fleet.13 }
		}
	}
}

# Migrant Fleet - tell us about yourselves - continued
country_event = {
	id = migrant_fleet.13
	title = migrant_fleet.7.name
	desc = migrant_fleet.13.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	option = {
		name = migrant_fleet.13.a
		hidden_effect = {
			country_event = { id = migrant_fleet.14 }
		}
	}
}

# Migrant Fleet - tell us about yourselves - continued 2
country_event = {
	id = migrant_fleet.14
	title = migrant_fleet.7.name
	desc = migrant_fleet.14.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	option = {
		name = migrant_fleet.14.a
		hidden_effect = {
			country_event = { id = migrant_fleet.8 }
		}
	}
}

# Migrant Fleet - hire leader - TODO quarian returns to fleet after pilgrimage
country_event = {
	id = migrant_fleet.11
	title = migrant_fleet.7.name
	desc = migrant_fleet.11.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	immediate = {
		create_leader = {
			class = scientist
			species = event_target:quarianSpecies
			name = random
			skill = 3
			traits = {
				trait = leader_trait_expertise_voidcraft
				trait = leader_trait_spark_of_genius
			}
			effect = {
				save_event_target_as = quarian_leader_hire
				exile_leader_as = quarian_leader_hire
			}
		}
	}
	option = {
		name = migrant_fleet.11.a
		custom_tooltip = migrant_fleet.11.a.tooltip
		allow = {
			has_resource = { type = energy amount >= 1500 }
		}
		add_resource = { energy = -1500 }
		hidden_effect = {
			set_timed_country_flag = {
				flag = migrant_fleet_recent_leader_hired
				days = 3600
			}
			set_country_flag = has_quarian_pilgrim
			event_target:migrant_fleet = {
				add_trust = {
					amount = 20
					who = root
				}
			}
			event_target:quarian_leader_hire = {
				set_owner = root
			}
			country_event = { id = migrant_fleet.8 }
		}
	}
	option = {
		name = migrant_fleet.11.b # never mind
		hidden_effect = {
			country_event = { id = migrant_fleet.8 }
		}
	}
}

# Migrant Fleet - hire leader after
country_event = {
	id = migrant_fleet.15
	title = migrant_fleet.7.name
	desc = migrant_fleet.15.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	immediate = {
		create_leader = {
			class = scientist
			species = event_target:quarianSpecies
			name = random
			skill = 3
			traits = {
				trait = leader_trait_expertise_voidcraft
				trait = leader_trait_spark_of_genius
			}
			effect = {
				save_event_target_as = quarian_leader_hire
				exile_leader_as = quarian_leader_hire
			}
		}
	}
	option = {
		name = migrant_fleet.11.a
		custom_tooltip = migrant_fleet.11.a.tooltip
		allow = {
			has_resource = { type = energy amount >= 1500 }
		}
		add_resource = { energy = -1500 }
		hidden_effect = {
			set_timed_country_flag = {
				flag = migrant_fleet_recent_leader_hired
				days = 3600
			}
			set_country_flag = has_quarian_pilgrim
			event_target:migrant_fleet = {
				add_trust = {
					amount = 10
					who = root
				}
			}
			event_target:quarian_leader_hire = {
				set_owner = root
			}
			country_event = { id = migrant_fleet.8 }
		}
	}
	option = {
		name = migrant_fleet.11.b # never mind
		hidden_effect = {
			country_event = { id = migrant_fleet.8 }
		}
	}
}

# Migrant Fleet - no leader available
country_event = {
	id = migrant_fleet.16
	title = migrant_fleet.7.name
	desc = migrant_fleet.16.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	option = {
		name = migrant_fleet.16.a
		hidden_effect = {
			country_event = { id = migrant_fleet.8 }
		}
	}
}

# Migrant Fleet - trade
country_event = {
	id = migrant_fleet.12
	title = migrant_fleet.7.name
	desc = migrant_fleet.12.desc
	diplomatic = yes
	is_triggered_only = yes
	picture_event_data = {
		portrait = event_target:migrant_fleet
		room = quarian_room
	}
	option = {
		name = migrant_fleet.12.a # Element Zero
		allow = {
			has_resource = { type = energy amount >= 5000 }
		}
		add_resource = { energy = -5000 }
		add_resource = { element_zero = 100 }
		hidden_effect = {
			event_target:migrant_fleet = {
				add_trust = {
					amount = 10
					who = root
				}
			}
			country_event = { id = migrant_fleet.12 }
		}
	}
	option = {
		name = migrant_fleet.12.b # Rare Crystals
		allow = {
			has_resource = { type = energy amount >= 2500 }
		}
		add_resource = { energy = -2500 }
		add_resource = { rare_crystals = 30 }
		hidden_effect = {
			event_target:migrant_fleet = {
				add_trust = {
					amount = 10
					who = root
				}
			}
			country_event = { id = migrant_fleet.12 }
		}
	}
	option = {
		name = migrant_fleet.12.c # Zro
		allow = {
			has_resource = { type = energy amount >= 5000 }
		}
		add_resource = { energy = -5000 }
		add_resource = { sr_zro = 20 }
		hidden_effect = {
			event_target:migrant_fleet = {
				add_trust = {
					amount = 10
					who = root
				}
			}
			country_event = { id = migrant_fleet.12 }
		}
	}
	option = {
		name = migrant_fleet.12.d
		hidden_effect = {
			country_event = { id = migrant_fleet.8 }
		}
	}
}